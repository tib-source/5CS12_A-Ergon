{%extends 'Bookings/base_main.html'%} {% block content %}

{{equipment|json_script:"data"}}

<script>

    /* 

    INSPIRED BY THE FOLLOWING ARTICLE : https://webdesign.tutsplus.com/how-to-create-a-sortable-html-table-with-javascript--cms-92993t
    
    */
    let tableData =
        JSON.parse(JSON.parse(document.getElementById("data").textContent))

    let tableButtons;
    let tableContent;

    const createRow = (obj) => {
        const row = document.createElement("tr");
        const objKeys = ['id', 'name', 'quantity', 'type', 'location', 'status', 'comment']
        objKeys.map((key) => {
            populateRow(row, obj[key], key);
        });
        // TODO: GET THE BOOKING BUTTON WORKING 
        const bookingButton = document.createElement("Button");
        bookingButton.innerHTML = "Book"
        bookingButton.classList.add("styled__button")
        bookingButton.setAttribute("data-book", obj["id"])
        bookingButton.onclick = toggleBookingModal
        row.appendChild(bookingButton)
        return row;
    };

    const toggleBookingModal = () =>{ 
        console.log("helo")
        const modal = document.getElementById('booking-modal')
        modal.style.visibility= modal.style.visibility == "hidden" ? 'visible' : 'hidden';
    }


    const populateRow = (row, item, key = "id") => {
        const cell = document.createElement("td");
        if (key == "status") {
            cell.classList.add("status")
            const span = document.createElement('span')
            span.innerHTML = item
            if (item == "On Loan") {
                span.classList.add("status__loan")
            } else span.classList.add(`status__${item.toLowerCase()}`)



            item = span.outerHTML
        }
        cell.setAttribute("data-attr", key);
        cell.innerHTML = item;
        row.appendChild(cell);
    };

    const getTableContent = (data) => {
        console.dir(typeof data);
        data.map((obj) => {
            const row = createRow(obj);
            tableContent.appendChild(row);
        });
    };


    const sortRow = (data, row, direction = "asc") => {
        // Clear out the table first 
        tableContent.innerHTML = ""
        // Use the direction to perform sorting
        const sortedData = direction == 'asc' ?
            [...data].sort(function (curr, next) {
                if (curr[row] > next[row]) {
                    return -1;
                } else if (curr[row] < next[row]) {
                    return 1;
                } else {
                    return 0;
                }
            }) : [...data].sort(function (curr, next) {
                if (curr[row] > next[row]) {
                    return 1;
                } else if (curr[row] < next[row]) {
                    return -1;
                } else {
                    return 0;
                }
            })
        getTableContent(sortedData);
    }


    const resetButtons = (event) => { 
        [...tableButtons].map((button)=>{ 
            if(button !== event.target){ 
                button.removeAttribute('data-dir')
            }
        })
    }


    const populateBookingDropdown = (data) => { 
        const dropdown = document.getElementById('bookingDropdown')

        // clear previous data 
        dropdown.innerHTML = "";
        // intiial default 
        const defaultOption = document.createElement('option')
        defaultOption.text = "Select Equipment"
        // Populate with json
        data.forEach(element => {
            let optionCurr = document.createElement('option')
            optionCurr.value = element.id
            optionCurr.text = element.id + " - " + element.name
            dropdown.add(optionCurr)
        });


        // Extra functionality 
        // Set the from date on the form to automatically be today: 
        let fromDate = document.getElementById("fromDate");
        fromDate.value = new Date().toISOString().slice(0, 10)
    }

    const handleBooking = (e) => { 
        let selectedEquipmentId = document.getElementById("bookingDropdown").value;
        let fromDate = document.getElementById("fromDate").value;
        let untilDate = document.getElementById("untilDate").value;
        let csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

        fetch('/api/book/', {
            method: "POST",
            headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
            }   , 
            body: JSON.stringify({ 
                id: selectedEquipmentId, 
                from: fromDate, 
                to: untilDate,
            })
        })

       // toggleBookingModal()
    }

    window.addEventListener("load", (e) => {

        tableContent = document.getElementById("table_content");
        tableButtons = document.querySelectorAll('.table__row');
        searchInput = document.getElementById('search_input')
        searchButton = document.getElementById("search_button");
        noResultDiv = document.createElement('div')

        // Event listener on the search button so that it can filter the table when it is clicked; 
        searchButton.addEventListener("click", (event)=>{ 

            event.preventDefault();
            // Get text from the search Bar 
            const query = searchInput.value.toLowerCase();
            // Clear the table 
            tableContent.innerHTML = ""
            // Filter the data using the query 
            const searchResult = [...tableData].filter((item)=> { 
                let result = item["name"].toLowerCase().includes(query);
                return result

            })
            // if search result is empty
            if(searchResult.length == 0){

                noResultDiv.innerHTML = `<p> No result for this search </p>`
                tableContent.appendChild(noResultDiv)
            }

            // Repopulate the table 
            getTableContent(searchResult)
        });

        // Event listeners on the Table columns so that they can sort the table when clicked 
        [...tableButtons].map((button) => { 
            button.addEventListener("click", (event)=> { 

                resetButtons(event);    

                if(event.target.getAttribute('data-dir') == 'desc'){ 
                    sortRow(tableData, event.target.innerHTML.toLowerCase(), "asc")
                    event.target.setAttribute('data-dir', 'asc')
                }else{ 
                    sortRow(tableData, event.target.innerHTML.toLowerCase(), "desc")
                    event.target.setAttribute('data-dir', 'desc')

                }

            })
        })


        getTableContent(tableData);
        populateBookingDropdown(tableData);

    });
</script>
<form action="/api/book" id="booking-modal" style="visibility: visible; z-index: 1;" >
    {% csrf_token %}

    <select  class="input__field" name="bookingDropdown" id="bookingDropdown">

    </select>

    <label for="fromDate">Default Date (Today):</label>
    <input type="date" id="fromDate" value="" >

    <label for="untilDate">Select Date:</label>
    <input type="date" id="untilDate">

    <button type="button" onclick="handleBooking()">book</button>
</form>

<div class="dashboard">
    <h1>Equipment List</h1>
    <form class="input__container">
        <input class="input__field" type="text" name="searchInput" autofocus=""  maxlength="150"  id="search_input">
        <button class="styled__button" id="search_button"> Search </button>
    </form>
    <table id="dashboard_table">
        <thead>
            <tr>
                <th><button class="table__row">Id</button></th>
                <th><button class="table__row">Name</button></th>
                <th><button class="table__row">Quantity</button></th>
                <th><button class="table__row">Type</button></th>
                <th><button class="table__row">Location</button></th>
                <th><button class="table__row">Status</button></th>
                <th><button class="table__row">Comment</button></th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="table_content"></tbody>
    </table>
</div>

{%endblock content %}